{% extends 'layouts/base_app.html' %}
{% load widget_tweaks %}
{% load safe_js %}

{% load static %}

{% block head %}
{{block.super}}
<link rel="stylesheet" href="{% static 'css/bootstrap-select.min.css' %}">

{% endblock head %}


{% block content %}
{{block.super}}
<div class="page-content sales__form" id="content">
    <h1>
        {% if editing %}
            Editando Compra
        {% else %}
            Creando Compra
        {% endif %}
    </h1>
    {% if form.non_field_errors %}
    {% for error in form.non_field_errors %}
        <div class="d-flex flex-row align-items-center">
            <i class="app__icon--alert mdi mdi-alert text-danger"></i>
            <p class="app__form--error text-danger mb-0 ml-3">
                {{ error }}
            </p>
        </div>
    {% endfor %}
{% endif %}
{% comment %} Formulario  {% endcomment %}
    <form id="sale_form" ref="form" action="{{form_url}}" method="POST" @submit.prevent="onSubmit" >
        {% csrf_token %}
        {% comment %} <input type="hidden" name="company" value="{{company.pk}}" >
        {% if not user.is_superuser %}
            <input type="hidden" name="company_user" value="{{company_user.pk}}" >
        {% endif %} {% endcomment %}
        <div>
            {{form.dollar_price.label_tag}}
            {% render_field form.dollar_price v-model="dollar_price" step="0.001" %}

        </div>
        <div>
            {{form.raw_materials.label_tag}}
            <p> {% render_field form.raw_materials  v-model="materials" @change="buildMaterials" class+="selectpicker col-8 mx-4" multiple="" data-live-search="true" title="Escoge las materias primas" %}</p>
        </div>
        <div id="materials_group" class="app__background--gray-300 d-flex flex-column overflow-y-scroll materials__list">
            {% include 'sales/_selected_sale.html' %}

        </div>

        <span> Si este no es el costo final cambielo a mano</span>
        <div>
            {{form.manual_costs.label_tag}}
            {% render_field form.manual_costs v-model="manualFinalCosts" %}
        </div>

        <div v-if="manualFinalCosts" >
            <div>
                {{form.total_cost_dollar.label_tag}}
                <p> {% render_field form.total_cost_dollar%}</p>
            </div>
            <div>
                {{form.total_cost_local.label_tag}}
                <p> {% render_field form.total_cost_local%}</p>
            </div>
        </div>

        <div v-else >
            <div>
                <label for="">Costo final dolares</label>
                <p>[[totalCostDolar | roundDecimals(3) ]]</p>
                <input type="hidden" name="total_cost_dollar" :value="totalCostDolar">
            </div>
            <div>
                <label for="">Costo final local</label>
                <p>[[totalCostLocal | roundDecimals(3) ]]</p>
                <input type="hidden" name="total_cost_local" :value="totalCostLocal" >

            </div>
        </div>

        <input type="hidden" name="raw_materials_json" :value="parsedMaterials" >

        <button type="submit" > Guardar</button>
    </form>

</div>

{% endblock content %}

{% block javascript %}
    {{block.super}}
    <script src="{% static 'js/bootstrap_select/bootstrap-select.min.js' %}"></script>
    <script src="{% static 'js/sales/sales_form/class.js' %}"></script>
    <script src="{% static 'js/sales/sales_form/functions.js' %}"></script>

<script>

var initial_dolar_price = {{form.dollar_price.value | safe}};

var app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    data: {
        materials: {% if raw_materials_string %}selectedMaterials({{raw_materials_string | safe }}){% elif editing %}{{materials_values | safe}}{% else %}[]{% endif %},
        formMaterials: {% if raw_materials_string %}objectsToRawMaterials({{raw_materials_string | safe }}){% elif editing %}objectsToRawMaterials({{form_materials | safe }}){% else %}[]{% endif %},
        manualFinalCosts: false,
        dollar_price: document.getElementById('id_dollar_price').value,
        raw_materials: {{ raw_materials | safe }},
        unit_system: {{unit_system | safe_js}},
    },
    methods: {
        onSubmit: function(){
            if (this.areMaterialsValid()) {
                this.$refs.form.submit();
            }else{
                window.scrollTo(0, 0);
            }
        },
        areMaterialsValid: function () {
            let valid = true;
            this.formMaterials.forEach(function(el){
                if (! el.isValid()) {
                    valid = el.isValid();
                }
            });
            return valid;
        },
        buildMaterials: function() {
            let selected = Array(this.materials.length);
            let self = this;

            for (let i = 0; i < this.materials.length; i++) {
                let value;
                value = this.formMaterials.find(function (el) {
                    return el.raw_material_pk === parseInt(self.materials[i]);
                });

                if (!value) {
                    value = this.raw_materials.find(function(el) {
                        return el.pk === parseInt(self.materials[i]);
                    });
                }
                // console.log(value);
                if (value instanceof RawMaterial) {
                    selected[i] = value;
                }else{
                    // console.log(value);

                    selected[i] = new RawMaterial(
                        0, // relation pk
                        value.pk,// raw material pk
                        value.name, // raw material name
                        1, // amount
                        value.measurement_unit,
                        false, //bought_in_dollars
                        1, //cost_dollar
                        1, //cost_local
                        0, //provider
                        Array.from(value.providers),
                    );
                }
                // console.log(selected[i])
            }
            self.formMaterials = selected;
        },
    },
    computed: {
        parsedMaterials: function(){
            // return JSON.stringify(this.formatFormMaterials());
            return JSON.stringify(this.formMaterials);
        },
        totalCostDolar: function() {
            let totalCost = 0;
            this.formMaterials.forEach(function (el) {
                if (el.bought_in_dollars) {
                    totalCost += el.cost_dollar * el.amount;
                } else {
                    totalCost += el.calculateDolarCost() * el.amount;
                }
            });
            return totalCost;
        },
        totalCostLocal: function() {
            return this.totalCostDolar * this.dollar_price;
        },

    },
    filters: {
        roundDecimals: function (x, roundTo) {
            return Number.parseFloat(x).toFixed(roundTo);
        }
    }
});

</script>
{% endblock javascript %}