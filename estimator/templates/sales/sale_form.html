{% extends 'layouts/base_app.html' %}
{% load widget_tweaks %}
{% load safe_js %}

{% load static %}

{% block head %}
{{block.super}}
<link rel="stylesheet" href="{% static 'css/bootstrap-select.min.css' %}">

{% endblock head %}


{% block content %}
{{block.super}}
<div class="page-content sales__form" id="content">
    <h1>
        {% if editing %}
            Editando Venta
        {% else %}
            Creando Venta
        {% endif %}
    </h1>
    <form action="" method="POST">
        {% csrf_token %}
        <input type="hidden" name="company" value="{{company.pk}}" >
        {% if not user.is_superuser %}
            <input type="hidden" name="company_user" value="{{company_user.pk}}" >
        {% endif %}
        <div>
            <label for="id_dolar_converion">Costo del dolar en moneda local</label>
            <input type="number" v-model="dolar_convertion_factor" placeholder="Costo local del dolar">
        </div>
        {% comment %} <span class="mdl-button">Obtener en bolivares</span> {% endcomment %}

        <div>
            {{form.raw_materials.label_tag}}
            <p> {% render_field form.raw_materials class+="selectpicker col-8 mx-4" multiple="" v-model="materials" data-live-search="true" title="Escoge los proveedores" %}</p>
        </div>
        <div class="app__background--gray-300 d-flex flex-column overflow-y-scroll materials__list">
            <div v-for="(item, index) in selected_materials()" class="p-4 border border-dark container"
                :key="index">
                <div class="row">
                    <p class="col-5">
                        Nombre: [[item.name]]
                    </p>

                    <div class="col-5">
                        <label :for="'amount' + index">Cantidad </label>
                        <input :id="'amount' + index" type="number" min="1" v-model="item.amount">
                        <p>[[ unit_system[item.measurement_unit] ]]</p>
                    </div>
                </div>
                <div class="row">
                    <div>
                        <label :for="'dollar_coin' + index">Costo Modena Dolar </label>
                        <input :id="'dollar_coin' + index" type="number" min="1" v-model="item.dollar_cost">
                    </div>
                    <div>
                        <label :for="'local_coin' + index">Costo Modena Local </label>
                        <input :id="'local_coin' + index" type="number" min="1" v-model="item.local_cost">
                    </div>
                </div>
            </div>

        </div>

        <div>
            {{form.total_cost_dollar.label_tag}}
            <p> {% render_field form.total_cost_dollar%}</p>
        </div>
        
        <div>
            {{form.total_cost_local.label_tag}}
            <p> {% render_field form.total_cost_local%}</p>
        </div>

        <input type="hidden" name="sold_materials[]" >
    </form>

</div>

{% endblock content %}

{% block javascript %}
    {{block.super}}
    <script src="{% static 'js/bootstrap_select/bootstrap-select.min.js' %}"></script>
<script>
var app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    data: {
        materials: [],
        raw_materials: {{ raw_materials | safe }},
        unit_system: {{unit_system | safe_js}},
        dolar_convertion_factor: 1,
        // selected_materials: [],
    },
    methods: {
        selected_materials: function() {
            let selected = Array(this.materials.length)
            let self = this;
            for (let i = 0; i < this.materials.length; i++) {
                selected[i] = this.raw_materials.find(function(el) {
                    return el.pk === parseInt(self.materials[i]);
                });
            }
            return selected
        },
        get_total_cost: function(){

        }
    }
});

</script>
{% endblock javascript %}